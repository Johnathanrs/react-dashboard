import * as d3 from "d3";

function buildVisualization(container, boundingClientRect, data, title) {
  //container.html("");
  //var containerSize = container.node().getBoundingClientRect();
  var containerSize = boundingClientRect;

  var margin = 20,
    radius = (containerSize.width > containerSize.height ? containerSize.height : containerSize.width) / 2 - margin;

  var arc = d3.svg.arc()
    .startAngle(function (d) {
      return d.startAngle;
    })
    .endAngle(function (d) {
      return d.endAngle;
    })
    .innerRadius(function (d) {
      return radius * 0.77;
    })
    .outerRadius(function (d) {
      return radius * 0.77 + 5;
    });

  var svg = container.append("svg")
    .attr("width", (radius + margin) * 2)
    .attr("height", (radius + margin) * 2)
    .append("g").attr("opacity", 1)
    .attr("transform", "translate(" + (margin + radius) + "," + (margin + radius) + ")");

  var iconSize = 13;
  var icons = [
    '<g opacity="0.4" fill="#FF7551" transform="translate(' + (-iconSize / 2) + ',' + (-iconSize / 2 - radius + 15) + ')"> <path d="M7,2.00063302 C3.98695238,2.00063302 2.14285714,3.04834658 2.14285714,3.61872347 C2.14285714,4.18910035 3.98695238,5.23681392 7,5.23681392 C10.0130476,5.23681392 11.8571429,4.18910035 11.8571429,3.61872347 C11.8571429,3.04834658 10.0130476,2.00063302 7,2.00063302 M7,6.85490437 C3.78133333,6.85490437 0.523809524,5.74327623 0.523809524,3.61872347 C0.523809524,1.49417071 3.78133333,0.382542565 7,0.382542565 C10.2186667,0.382542565 13.4761905,1.49417071 13.4761905,3.61872347 C13.4761905,5.74327623 10.2186667,6.85490437 7,6.85490437" /> <path d="M7,10.0910853 C3.78133333,10.0910853 0.523809524,8.97945714 0.523809524,6.85490437 L0.523809524,3.61872347 C0.523809524,3.17132146 0.885666667,2.80967824 1.33333333,2.80967824 C1.781,2.80967824 2.14285714,3.17132146 2.14285714,3.61872347 L2.14285714,6.85490437 C2.14285714,7.42528126 3.98695238,8.47299483 7,8.47299483 C10.0130476,8.47299483 11.8571429,7.42528126 11.8571429,6.85490437 L11.8571429,3.61872347 C11.8571429,3.17132146 12.219,2.80967824 12.6666667,2.80967824 C13.1143333,2.80967824 13.4761905,3.17132146 13.4761905,3.61872347 L13.4761905,6.85490437 C13.4761905,8.97945714 10.2186667,10.0910853 7,10.0910853" /> <path d="M7,13.3272662 C3.78133333,13.3272662 0.523809524,12.215638 0.523809524,10.0910853 L0.523809524,6.85490437 C0.523809524,6.40750236 0.885666667,6.04585915 1.33333333,6.04585915 C1.781,6.04585915 2.14285714,6.40750236 2.14285714,6.85490437 L2.14285714,10.0910853 C2.14285714,10.6614622 3.98695238,11.7091757 7,11.7091757 C10.0130476,11.7091757 11.8571429,10.6614622 11.8571429,10.0910853 L11.8571429,6.85490437 C11.8571429,6.40750236 12.219,6.04585915 12.6666667,6.04585915 C13.1143333,6.04585915 13.4761905,6.40750236 13.4761905,6.85490437 L13.4761905,10.0910853 C13.4761905,12.215638 10.2186667,13.3272662 7,13.3272662" /> </g>',
    '<g opacity="0.4" fill="#777CA4" transform="translate(' + (-iconSize / 2) + ',' + (-iconSize / 2 - 142 - radius + 15) + ')"> <path d="M8.00451963,144.680898 L5.5759482,144.680898 C5.12909106,144.680898 4.76642439,144.318446 4.76642439,143.871853 C4.76642439,143.42526 5.12909106,143.062808 5.5759482,143.062808 L8.00451963,143.062808 C8.45137678,143.062808 8.81404344,143.42526 8.81404344,143.871853 C8.81404344,144.318446 8.45137678,144.680898 8.00451963,144.680898" id="Fill-1" transform="translate(6.790234, 143.871853) rotate(-90.000000) translate(-6.790234, -143.871853) "/><path d="M8.00228739,153.584423 L5.57371596,153.584423 C5.12685882,153.584423 4.76419215,153.221971 4.76419215,152.775378 C4.76419215,152.328785 5.12685882,151.966333 5.57371596,151.966333 L8.00228739,151.966333 C8.44914454,151.966333 8.8118112,152.328785 8.8118112,152.775378 C8.8118112,153.221971 8.44914454,153.584423 8.00228739,153.584423" id="Fill-3" transform="translate(6.788002, 152.775378) rotate(-90.000000) translate(-6.788002, -152.775378) "/><path d="M2.33875038,150.347345 C1.89189324,150.347345 1.52922657,149.984892 1.52922657,149.538299 L1.52922657,147.111164 C1.52922657,146.664571 1.89189324,146.302119 2.33875038,146.302119 C2.78560752,146.302119 3.14827419,146.664571 3.14827419,147.111164 L3.14827419,149.538299 C3.14827419,149.984892 2.78560752,150.347345 2.33875038,150.347345" id="Fill-5" transform="translate(2.338750, 148.324732) rotate(-90.000000) translate(-2.338750, -148.324732) "/><path d="M10.8364953,146.266565 C10.6292572,146.266565 10.4220191,146.187279 10.264162,146.030324 L9.08144769,144.849118 C8.76492388,144.532781 8.76492388,144.020656 9.08063817,143.704319 C9.39716198,143.387982 9.90959055,143.388791 10.2261144,143.704319 L11.4088286,144.884716 C11.7253525,145.201053 11.7253525,145.713178 11.4096382,146.029515 C11.2509715,146.187279 11.0437334,146.266565 10.8364953,146.266565" id="Fill-7" transform="translate(10.245138, 144.866967) rotate(-90.000000) translate(-10.245138, -144.866967) "/><path d="M3.92374589,153.180671 C3.7165078,153.180671 3.5092697,153.101384 3.35060303,152.943621 L2.1695078,151.762415 C1.85379351,151.446078 1.85379351,150.933952 2.17031732,150.618425 C2.48684113,150.302897 2.9992697,150.302088 3.31579351,150.618425 L4.49688875,151.799631 C4.81260303,152.115967 4.81260303,152.628093 4.49607923,152.94443 C4.33822208,153.101384 4.13098399,153.180671 3.92374589,153.180671" id="Fill-9" transform="translate(3.333198, 151.781073) rotate(-90.000000) translate(-3.333198, -151.781073) "/><path d="M6.7891178,145.89648 C6.14149875,145.89648 5.52949875,146.148902 5.06564161,146.607631 C4.6131178,147.064741 4.36054637,147.676379 4.36054637,148.323616 C4.36054637,148.971661 4.6131178,149.583299 5.07130827,150.045264 C5.98849875,150.950585 7.58326066,150.956249 8.51259399,150.0396 C8.9651178,149.581681 9.21768923,148.970043 9.21768923,148.323616 C9.21768923,147.677997 8.9651178,147.06555 8.50530827,146.600349 C8.04873685,146.148902 7.43673685,145.89648 6.7891178,145.89648 M6.7891178,152.368842 C5.71326066,152.368842 4.69730827,151.950565 3.92745113,151.190872 C3.16083208,150.416616 2.74149875,149.400455 2.74149875,148.323616 C2.74149875,147.247585 3.16083208,146.232234 3.92097494,145.463641 C4.69649875,144.697475 5.71245113,144.278389 6.7891178,144.278389 C7.86578446,144.278389 8.88173685,144.697475 9.65078446,145.457168 C10.418213,146.233852 10.8367368,147.249203 10.8367368,148.323616 C10.8367368,149.398837 10.418213,150.414188 9.65807018,151.18359 C8.88092732,151.950565 7.86497494,152.368842 6.7891178,152.368842" id="Fill-11" transform="translate(6.789118, 148.323616) rotate(-90.000000) translate(-6.789118, -148.323616) "/><path d="M9.65285752,153.178938 C9.44561942,153.178938 9.23838133,153.099651 9.08052419,152.942697 C8.76400038,152.62636 8.76400038,152.114234 9.07971466,151.797898 L10.2608099,150.616692 C10.5773337,150.300355 11.0897623,150.301164 11.4062861,150.616692 C11.7228099,150.932219 11.7228099,151.444345 11.4070956,151.760681 L10.2260004,152.941888 C10.0673337,153.099651 9.86009561,153.178938 9.65285752,153.178938" id="Fill-13" transform="translate(10.243405, 151.779340) rotate(-90.000000) translate(-10.243405, -151.779340) "/><path d="M2.74362481,146.268268 C2.53638672,146.268268 2.32914862,146.188981 2.17048195,146.031218 C1.85476767,145.714881 1.85476767,145.202755 2.17129148,144.886419 L3.35400576,143.706022 C3.67052957,143.390494 4.18295814,143.389685 4.49867243,143.706022 C4.81519624,144.022358 4.81519624,144.534484 4.49867243,144.850821 L3.31595814,146.032027 C3.158101,146.188981 2.95086291,146.268268 2.74362481,146.268268" id="Fill-15" transform="translate(3.334931, 144.868670) rotate(-90.000000) translate(-3.334931, -144.868670) "/><path d="M11.2394852,150.345112 C10.7926281,150.345112 10.4299614,149.98266 10.4299614,149.536067 L10.4299614,147.108932 C10.4299614,146.662339 10.7926281,146.299886 11.2394852,146.299886 C11.6863424,146.299886 12.049009,146.662339 12.049009,147.108932 L12.049009,149.536067 C12.049009,149.98266 11.6863424,150.345112 11.2394852,150.345112" id="Fill-17" transform="translate(11.239485, 148.322499) rotate(-90.000000) translate(-11.239485, -148.322499) "/> </g>',
    '<g opacity="0.4" fill="#4FB1E2" transform="translate(' + (-iconSize / 2 - 186) + ',' + (-iconSize / 2 - 130 - radius + 15) + ')"><path d="M187.666667,134.055909 L190.095238,134.055909 L190.095238,131.628774 L187.666667,131.628774 L187.666667,134.055909 Z M190.904762,135.674 L186.857143,135.674 C186.410286,135.674 186.047619,135.312357 186.047619,134.864955 L186.047619,130.819728 C186.047619,130.372326 186.410286,130.010683 186.857143,130.010683 L190.904762,130.010683 C191.351619,130.010683 191.714286,130.372326 191.714286,130.819728 L191.714286,134.864955 C191.714286,135.312357 191.351619,135.674 190.904762,135.674 L190.904762,135.674 Z" id="Fill-1"/><path d="M194.952381,134.055909 L197.380952,134.055909 L197.380952,131.628774 L194.952381,131.628774 L194.952381,134.055909 Z M198.190476,135.674 L194.142857,135.674 C193.696,135.674 193.333333,135.312357 193.333333,134.864955 L193.333333,130.819728 C193.333333,130.372326 193.696,130.010683 194.142857,130.010683 L198.190476,130.010683 C198.637333,130.010683 199,130.372326 199,130.819728 L199,134.864955 C199,135.312357 198.637333,135.674 198.190476,135.674 L198.190476,135.674 Z" id="Fill-3"/><path d="M187.666667,141.337316 L190.095238,141.337316 L190.095238,138.910181 L187.666667,138.910181 L187.666667,141.337316 Z M190.904762,142.955407 L186.857143,142.955407 C186.410286,142.955407 186.047619,142.593764 186.047619,142.146362 L186.047619,138.101136 C186.047619,137.653734 186.410286,137.29209 186.857143,137.29209 L190.904762,137.29209 C191.351619,137.29209 191.714286,137.653734 191.714286,138.101136 L191.714286,142.146362 C191.714286,142.593764 191.351619,142.955407 190.904762,142.955407 L190.904762,142.955407 Z" id="Fill-4"/><path d="M194.952381,141.337316 L197.380952,141.337316 L197.380952,138.910181 L194.952381,138.910181 L194.952381,141.337316 Z M198.190476,142.955407 L194.142857,142.955407 C193.696,142.955407 193.333333,142.593764 193.333333,142.146362 L193.333333,138.101136 C193.333333,137.653734 193.696,137.29209 194.142857,137.29209 L198.190476,137.29209 C198.637333,137.29209 199,137.653734 199,138.101136 L199,142.146362 C199,142.593764 198.637333,142.955407 198.190476,142.955407 L198.190476,142.955407 Z" id="Fill-5"/></g>'
  ];

  var totalLength = data[0].length + data[1].length + data[2].length;
  var angle = 360 / totalLength, angleRad = 2 * Math.PI / totalLength;
  var arcData = [], arcColors = ["#FF7551", "#4FB1E2", "#777CA4"];

  var di = 0;
  data.forEach(function (g, gi) {
    if (g.length == 0) return;

    if (g.length == totalLength) {
      arcData.push({startAngle: 0, endAngle: 2 * Math.PI, fill: arcColors[gi]});
    } else if (g.length == 1) {
      arcData.push({startAngle: (di - 0.3) * angleRad, endAngle: (di + 0.3) * angleRad, fill: arcColors[gi]});
    } else {
      arcData.push({startAngle: di * angleRad, endAngle: (di + g.length - 1) * angleRad, fill: arcColors[gi]});
    }

    g.forEach(function (d) {
      svg.append("g").datum(d).attr("transform", "rotate(" + (angle * di) + " 0,0)").html(icons[gi])
        .append("rect").attr("width", 14).attr("height", 14)
        .attr("x", -7).attr("y", (-7 - radius + 15)).style("cursor", "pointer").style("fill", "transparent")
        .append("title").text(d.appName);

      svg.append("g").attr("transform", "rotate(" + (angle * di) + " 0,0)")
        .append("text").attr("text-anchor", "middle").attr("x", 0).attr("y", (-radius * 0.65)).text(d.appCount)
        .style("font-size", "10px").style("opacity", 0.8);

      svg.append("g").attr("transform", "rotate(" + (angle * di) + " 0,0)")
        .append("text").attr("text-anchor", "middle").attr("x", 0).attr("y", (-radius)).text(d.appName.toUpperCase().substring(0, 1))
        .style("font-size", "10px").style("opacity", 0.8);

      di++;
    });
  });

  svg.selectAll(".arc").data(arcData).enter()
    .append("path").attr("class", "arc").attr("d", arc).style("fill", function (d) {
      return d.fill;
    });

  if (title != null) {
    svg.append("text").attr("text-anchor", "middle").attr("x", 0).attr("y", 4).style("font-size", "12px").text(title);
  }

  //svg.transition().duration(1000).attr("opacity", 1);
}

export default buildVisualization;
